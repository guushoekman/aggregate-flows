<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aggregate Flows</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.14.0/css/all.css" integrity="sha384-VhBcF/php0Z/P5ZxlxaEx1GwqTQVIBu4G4giRWxTKOCjTxsPFETUDdVL5B6vYvOt" crossorigin="anonymous">
  <style>
    svg {
      width: 100%;
      height: auto;
      transition: width .3s;
    }

    svg.global-view.minimized {
      width: 25%;
    }

    .flow,
    .node {
      cursor: pointer;
    }

    .flow.opaque {
      opacity: .1;
    }

    .popover-header,
    .popover-body {
      padding: 6px 12px;
    }

    .node.active {
      stroke: #000;
    }

    text {
      pointer-events: none;
    }

    table.table {
      margin-bottom: 0;
    }

    .select-material {
      width: 100%;
    }

    .close-sankey {
      position: absolute;
      top: 0;
      right: 0;
      height: 1.5rem;
      width: 1.5rem;
      line-height: 1.5rem;
      background-color: #efefef;
      cursor: pointer;
      text-align: center;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-light">
    <div class="container">
      <a class="navbar-brand" href="#">Aggregate flows</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded=false aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>
  <div class="container pt-4">
    <h2>Highlight by material</h2>
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="select-material btn btn-outline-primary" data-material="Sand and gravel">
          <i class="fal fa-fw me-1 fa-umbrella-beach"></i> Sand and gravel
        </div>
      </div>
      <div class="col-md-3">
        <div class="select-material btn btn-outline-danger" data-material="Rock">
          <i class="fal fa-fw me-1 fa-mountain"></i> Rock
        </div>
      </div>
    </div>

    <svg class="global-view" width="2000" height="500" viewBox="0 0 505.88 132.03" xmlns="http://www.w3.org/2000/svg">
      <text x="196" y="5" font-size="6">Export</text>
      <text x="302" y="5" font-size="6">Import</text>
      <text x="390" y="5" font-size="6">Import</text>

      <!-- reserves to extraction -->
      <rect class="flow" data-index="0" x="40.217" y="42.598" width="52.917" height="24.342"/>
      <rect class="flow" data-index="1" x="40.217" y="66.94" width="52.917" height="11.642"/>
      <rect class="flow" data-index="2" x="40.217" y="78.581" width="52.917" height="4.2333"/>

      <!-- extraction to processing -->
      <rect class="flow" data-index="3" x="133.35" y="47.625" width="52.917" height="8.7312"/>
      <rect class="flow" data-index="4" x="133.35" y="56.356" width="52.917" height="21.431"/>

      <!-- extraction to waste -->
      <path class="flow" data-index="5" d="m109.01 82.814v49.213h379.68v-49.213h-2.9103v46.302h-373.86v-46.302z"/>

      <!-- extraction to use -->
      <path class="flow" data-index="6" d="m114.56 82.815v43.127h288.66v-43.127h-2.9104v40.217h-282.84v-40.217z"/>

      <!-- processing to manufacturing -->
      <rect class="flow" data-index="7" x="226.48" y="52.387" width="52.917" height="3.175"/>
      <rect class="flow" data-index="8" x="226.48" y="55.562" width="52.917" height="3.175"/>
      <rect class="flow" data-index="9" x="226.48" y="58.737" width="52.917" height="5.0271"/>
      <rect class="flow" data-index="10" x="226.48" y="63.765" width="52.917" height=".79375"/>
      <rect class="flow" data-index="11" x="226.48" y="64.558" width="52.917" height=".79375"/>
      <rect class="flow" data-index="12" x="226.48" y="65.352" width="52.917" height="1.3229"/>
      <rect class="flow" data-index="13" x="226.48" y="66.675" width="52.917" height="1.8521"/>

      <!-- processing to export -->
      <rect class="flow" data-index="14" x="191.56" width="1.5875" height="42.598"/>

      <!-- processing to waste -->
      <path class="flow" data-index="15" d="m192.62 82.815v37.835h290.51v-37.835h-3.175v34.66h-284.16v-34.66z"/>

      <!-- processing to use -->
      <path class="flow" data-index="16" d="m200.55 82.815v31.485h193.67v-31.485h-2.6458v28.84h-188.38v-28.84z"/>
      <path class="flow" data-index="17" d="m203.2 82.815v28.84h188.39v-7.6729h-6e-3v-21.167h-7.6729v21.167h-173.04v-21.167z"/>

      <!-- waste to processing -->
      <path class="flow" data-index="18" d="m205.58 24.077v18.521h10.848v-7.6729h275.17v7.6729h10.848v-18.521h-10.848z"/>
      <path class="flow" data-index="19" d="m216.43 34.925v7.6729h1.5875v-6.0854h271.99v6.0854h1.5875v-7.6729h-273.58z"/>

      <!-- manufacturing to use -->
      <rect class="flow" data-index="20" x="319.62" y="60.854" width="52.917" height="1.0583"/>
      <rect class="flow" data-index="21" x="319.62" y="61.912" width="52.917" height="4.2333"/>

      <!-- manufacturing to waste -->
      <path class="flow" data-index="22" d="m297.92 82.815v14.817h179.92v-14.817h-2.9104v11.906h-174.1v-11.906z"/>

      <!-- import to manufacturing -->
      <rect class="flow" data-index="23" x="297.92" width="2.1167" height="42.598"/>

      <!-- import to use -->
      <rect class="flow" data-index="24" x="385.43" width="2.3812" height="44.319"/>

      <!-- use to waste -->
      <rect class="flow" data-index="25" x="412.75" y="59.531" width="52.917" height="7.4083"/>

      <!-- waste to use -->
      <path class="flow" data-index="26" d="m393.7 37.306v5.2917h1.3229v-3.9688h90.488v3.9688h1.3229v-5.2917h-91.81z"/>

      <!-- nodes -->
      <rect class="node" data-name="Reserves" y="42.598" width="40.217" height="40.217" fill="#ececec"/>
      <text x="6.8749571" y="65.075249"><tspan x="6.8749571" y="65.075249" style="fill:#000000;font-family:FreeSans;font-size:6.35px;" sodipodi:role="line">Reserves</tspan></text>

      <rect class="node" data-name="Extraction" x="93.133" y="42.598" width="40.217" height="40.217" fill="#ececec"/>
      <text x="99.389206" y="65.075249"><tspan x="99.389206" y="65.075249" style="fill:#000000;font-family:FreeSans;font-size:6.35px;" sodipodi:role="line">Extraction</tspan></text>

      <rect class="node" data-name="Processing / production" x="186.27" y="42.598" width="40.217" height="40.217" fill="#ececec"/>
      <text x="206.89563" y="60.359631"><tspan x="206.89563" y="60.359631" style="fill:#000000;font-family:FreeSans;font-size:6.35px;text-align:center;text-anchor:middle" sodipodi:role="line">Processing / </tspan><tspan x="206.89563" y="68.55262" style="fill:#000000;font-family:FreeSans;font-size:6.35px;text-align:center;text-anchor:middle" sodipodi:role="line">production</tspan></text>

      <rect class="node" data-name="Manufacturing" x="279.4" y="42.598" width="40.217" height="40.217" fill="#ececec"/>
      <text x="299.45193" y="64.284325"><tspan x="299.45193" y="64.284325" style="fill:#000000;font-family:FreeSans;font-size:5.6444px;text-align:center;text-anchor:middle" sodipodi:role="line">Manufacturing</tspan></text>

      <rect class="node" data-name="Use" x="372.53" y="42.598" width="40.217" height="40.217" fill="#ececec"/>
      <text x="392.58527" y="64.284325"><tspan x="392.58527" y="64.284325" style="fill:#000000;font-family:FreeSans;font-size:5.6444px;text-align:center;text-anchor:middle" sodipodi:role="line">Use</tspan></text>

      <rect class="node" data-name="Waste management" x="465.67" y="42.598" width="40.217" height="40.217" fill="#ececec"/>
      <text x="485.66217" y="60.634529"><tspan x="485.66217" y="60.634529" style="fill:#000000;font-family:FreeSans;font-size:5.6444px;text-align:center;text-anchor:middle" sodipodi:role="line">Waste</tspan><tspan x="485.66217" y="67.917183" style="fill:#000000;font-family:FreeSans;font-size:5.6444px;text-align:center;text-anchor:middle" sodipodi:role="line">management</tspan></text>
    </svg>

    <!--
    <div class="row mt-4 pt-4" id="inputs-ouputs" hidden>
      <h2 id="node-title"></h2>
      <div class="col">
        <h5>Inputs</h5>
        <div class="border border-bottom-0">
          <table class="table" id="table-input">
            <thead>
              <tr>
                <th>Name</th>
                <th>From</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>

            </tbody>
          </table>
        </div>

      </div>

      <div class="col">
        <h5>Outputs</h5>
        <div class="border border-bottom-0">
          <table class="table" id="table-output">
            <thead>
              <tr>
                <th>Name</th>
                <th>To</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>

        </div>
      </div>
    </div>

    <div class="mt-4 pt-4" id="category" hidden>
      <h2 id="category-title"></h2>
      <div class="border border-bottom-0">
        <table class="table" id="table-category">
          <thead>
            <tr>
              <th>Name</th>
              <th>From</th>
              <th>To</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>

          </tbody>
        </table>
      </div>
    </div>
     -->

    <div class="sankey-wrapper position-relative border p-4 mt-4" hidden>
      <div class="close-sankey border-start border-bottom"><i class="fal fa-times"></i></div>
      <div class="sankey" data-box="reserves" hidden></div>
      <div class="sankey" data-box="extraction" hidden></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
  <!-- <script src="https://code.highcharts.com/highcharts.js"></script> -->
  <!-- <script src="https://code.highcharts.com/modules/sankey.js"></script> -->

  <script src='https://cdn.plot.ly/plotly-2.12.1.min.js'></script>

  <script>
    const flows = [
     {
       "label": "Land won crushed rock",
       "from": "Reserves",
       "to": "Extraction",
       "value": 92195,
       "category": "Rock",
       "color": "#e41a1c"
     },
     {
       "label": "Land won sand and gravel",
       "from": "Reserves",
       "to": "Extraction",
       "value": 44124,
       "category": "Sand and gravel",
       "color": "#377eb8"
     },
     {
       "label": "Marine dredged sand and gravel",
       "from": "Reserves",
       "to": "Extraction",
       "value": 15946,
       "category": "Sand and gravel",
       "color": "#308edb"
     },
     {
       "label": "Raw sand and gravel",
       "from": "Extraction",
       "to": "Processing / production",
       "value": 33419,
       "category": "Sand and gravel",
       "color": "#377eb8"
     },
     {
       "label": "Raw crushed rock",
       "from": "Extraction",
       "to": "Processing / production",
       "value": 81488,
       "category": "Rock",
       "color": "#e41a1c"
     },
     {
       "label": "Overburden / interburden",
       "from": "Extraction",
       "to": "Waste management",
       "value": 10706,
       "category": false,
       "color": "#b2b260"
     },
     {
       "label": "Aggregates used as fill",
       "from": "Extraction",
       "to": "Use",
       "value": 10633,
       "category": false,
       "color": "#8e8e39"
     },
     {
       "label": "Concreting crushed rock",
       "from": "Processing / production",
       "to": "Manufacturing",
       "value": 11886,
       "category": "Rock",
       "color": "#e41a1c"
     },
     {
       "label": "Concreting gravel",
       "from": "Processing / production",
       "to": "Manufacturing",
       "value": 11563,
       "category": "Sand and gravel",
       "color": "#377eb8"
     },
     {
       "label": "Concreting sand",
       "from": "Processing / production",
       "to": "Manufacturing",
       "value": 19106,
       "category": "Sand and gravel",
       "color": "#a6cee3"
     },
     {
       "label": "Asphalt sand",
       "from": "Processing / production",
       "to": "Manufacturing",
       "value": 929,
       "category": "Sand and gravel",
       "color": "#a6cee3"
     },
     {
       "label": "Asphalt gravel",
       "from": "Processing / production",
       "to": "Manufacturing",
       "value": 458,
       "category": "Sand and gravel",
       "color": "#377eb8"
     },
     {
       "label": "Asphalt crushed rock",
       "from": "Processing / production",
       "to": "Manufacturing",
       "value": 4025,
       "category": "Rock",
       "color": "#e41a1c"
     },
     {
       "label": "Mortal sand",
       "from": "Processing / production",
       "to": "Manufacturing",
       "value": 5634,
       "category": "Sand and gravel",
       "color": "#a6cee3"
     },
     {
       "label": "Exports of processed sand, gravel and crushed rock",
       "from": "Processing / production",
       "to": "Export",
       "value": 4949,
       "category": false,
       "color": "#b15928"
     },
     {
       "label": "Scalping and fines",
       "from": "Processing / production",
       "to": "Waste management",
       "value": 11886,
       "category": false,
       "color": "#967630"
     },
     {
       "label": "Non-aggregate use",
       "from": "Processing / production",
       "to": "Use",
       "value": 9909,
       "category": false,
       "color": "#c93c7b"
     },
     {
       "label": "Other aggregates",
       "from": "Processing / production",
       "to": "Use",
       "value": 29127,
       "category": false,
       "color": "#96305e"
     },
     {
       "label": "Recycled C&D flows",
       "from": "Waste management",
       "to": "Processing / production",
       "value": 40790,
       "category": false,
       "color": "#96305e"
     },
     {
       "label": "Recycled processing / production waste",
       "from": "Waste management",
       "to": "Processing / production",
       "value": 6535,
       "category": false,
       "color": "#458926"
     },
     {
       "label": "Concrete, asphalt and mortar for infrastructure",
       "from": "Manufacturing",
       "to": "Use",
       "value": 676,
       "category": "Concrete, asphalt and mortar ",
       "color": "#c63574"
     },
     {
       "label": "Concrete, asphalt and mortar for building",
       "from": "Manufacturing",
       "to": "Use",
       "value": 15564,
       "category": "Concrete, asphalt and mortar ",
       "color": "#ba7895"
     },
     {
       "label": "Manufacturing waste",
       "from": "Manufacturing",
       "to": "Waste management",
       "value": 10666,
       "category": false,
       "color": "#7a7a56"
     },
     {
       "label": "Imports of processed sand, gravel and crushed rock",
       "from": "Import",
       "to": "Manufacturing",
       "value": 8467,
       "category": false,
       "color": "#6a3d9a"
     },
     {
       "label": "Processed crushed rock imports",
       "from": "Import",
       "to": "Use",
       "value": 8922,
       "category": "Rock",
       "color": "#e41a1c"
     },
     {
       "label": "End-of-life",
       "from": "Use",
       "to": "Waste management",
       "value": 28024,
       "category": false,
       "color": "#7a7a56"
     },
     {
       "label": "Recycling deconstruction flows",
       "from": "Waste management",
       "to": "Use",
       "value": 5237,
       "category": false,
       "color": "#7a7a56"
     }
    ]

    $(flows).each(function(index, flow) {
      $(".flow[data-index='" + index + "']").attr({
        "data-bs-toggle": "popover",
        "data-bs-trigger": "hover focus",
        "data-bs-placement": "left",
        "data-bs-title": flow.label,
        "data-bs-content": flow.from + " → " + flow.to + ": " + flow.value + "kt",
        "fill": flow.color,
      })
    })

    // enable popups
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
    const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl))

    $(".node").hover(
      function() {
        let node = $(this);
        let name = node.data("name");

        $(".node").removeClass("active")
        $(this).addClass("active")

        $(".flow").addClass("opaque")

        $(".select-material").removeClass("active")

        $("#category").attr("hidden", "hidden");

        $("#node-title").text(name);

        // clear input/output tables
        $("#inputs-ouputs tbody").html("");

        $(flows).each(function(index, flow) {
          if (flow.to == name) {
            $(".flow[data-index='" + index + "']").removeClass("opaque")
            $("#table-input tbody").append("<tr><td>" + flow.label + "</td><td>" + flow.from + "</td><td>" + flow.value + "kt</td></tr>")
          } else if (flow.from == name) {
            $(".flow[data-index='" + index + "']").removeClass("opaque")
            $("#table-output tbody").append("<tr><td>" + flow.label + "</td><td>" + flow.to + "</td><td>" + flow.value + "kt</td></tr>")
          }
        })

        $("#inputs-ouputs").removeAttr("hidden")
      }, function() {
        $(".flow").removeClass("opaque")
        $(".node").removeClass("active")
      }
    );

    $(".node").click(function() {
      let node = $(this);
      let name = node.data("name");

      $("svg").addClass("minimized");

      // Highcharts.chart('sankey', {
      //   title: {
      //     text: 'Highcharts Sankey Diagram'
      //   },
      //   accessibility: {
      //     point: {
      //       valueDescriptionFormat: '{index}. {point.from} to {point.to}, {point.weight}.'
      //     }
      //   },
      //   series: [{
      //     keys: ['from', 'to', 'weight'],
      //     data: [
      //       ['Reserves', 'Terrestrial', 5352],
      //       ['Reserves', 'Marine', 5352],
      //       ['Terrestrial', 'Crushed rock', 92194],
      //       ['Terrestrial', 'Sand', 44124],
      //       ['Crushed rock', 'Extraction', 92194],
      //       ['Sand', 'Extraction', 44124],
      //     ],
      //     type: 'sankey',
      //     name: 'Sankey demo series'
      //   }]
      // });

      $(".sankey-wrapper").removeAttr("hidden")

      var data = [{
        type: "sankey",
          arrangement: "snap",
          node:{
              label: ["Reserves", "Terrestrial", "Marine", "Crushed rock", "Sand", "Extraction", "Sand and gravel"],
              // x: [0.2, 0.1, 0.5, 0.7, 0.3, 0.5],
              // y: [0.7, 0.5, 0.2, 0.4, 0.2, 0.3],
              pad: 5}, // 10 Pixels
          link: {
              source: [0,    0,    1,     1,     3,     4,     2,     6],
              target: [1,    2,    3,     4,     5,     5,     6,     5],
              value:  [5352, 5352, 92194, 44124, 92194, 44124, 15946, 15946]}
          }]

      var layout = {"title": "Reserves"}

      Plotly.newPlot('sankey', data, layout, {displayModeBar: false})

    })

    $(".close-sankey").click(function() {
      $(".sankey-wrapper").attr("hidden", "hidden");
      $("svg").removeClass("minimized");
    })

    $(".flow").click(function() {
      let flow = $(this);
      let index = flow.data("index");

      $(".flow").addClass("opaque")
      $(".node").removeClass("active")

      $("#inputs-ouputs").attr("hidden", "hidden");
      $("#category").removeAttr("hidden");

      // clear input/output tables
      $("#inputs-ouputs tbody").html("");

      let category = flows[index].category

      // clear category table
      $("#table-category tbody").html("");

      if (category) {
        highlightMaterial(category)
      } else {
        $(".select-material").removeClass("active")
        $("#category-title").text(flows[index].label);
        $(".flow[data-index='" + index + "']").removeClass("opaque")
        $("#table-category tbody").append("<tr><td>" + flows[index].label + "</td><td>" + flows[index].from + "</td><td>" + flows[index].to + "</td><td>" + flows[index].value + "kt</td></tr>")
      }
    })

    $(".select-material").click(function() {
      $(".flow").addClass("opaque")
      $(".node").removeClass("active")

      $("#inputs-ouputs").attr("hidden", "hidden");
      $("#category").removeAttr("hidden");

      // clear input/output tables
      $("#inputs-ouputs tbody").html("");

      // clear category table
      $("#table-category tbody").html("");


      let category = $(this).data("material")
      highlightMaterial(category)
    })

    function highlightMaterial(material) {
      $("#category-title").text(material);
      $(".select-material").removeClass("active")
      $(".select-material[data-material='" + material + "']").addClass("active")
      $(flows).each(function(i, flow) {
        if (flow.category == material) {
          $(".flow[data-index='" + i + "']").removeClass("opaque")
          $("#table-category tbody").append("<tr><td>" + flow.label + "</td><td>" + flow.from + "</td><td>" + flow.to + "</td><td>" + flow.value + "kt</td></tr>")
        }
      })
    }
  </script>
</body>
</html>